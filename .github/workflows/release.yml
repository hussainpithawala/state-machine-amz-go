# .github/workflows/release.yml
name: Release Go Package

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0, v1.2.3-beta.1
  workflow_dispatch: # Allow manual triggering
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'
      skip_tests:
        description: 'Skip tests (for debugging)'
        required: false
        default: false

env:
  # Go configuration
  GO_VERSION: '1.23'
  GOPROXY: 'https://proxy.golang.org,direct'
  GOSUMDB: 'sum.golang.org'

  # Module name - update this to match your module
  MODULE_PATH: 'github.com/hussainpithawala/state-machine-amz-go'

permissions:
  contents: write
  id-token: write  # Required for Go package provenance

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    if: ${{ !github.event.inputs.skip_tests || github.event.inputs.skip_tests == 'false' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go ${{ env.GO_VERSION }}
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: true

      - name: Verify go.mod
        run: |
          ACTUAL_MODULE=$(go list -m)
          if [ "$ACTUAL_MODULE" != "$MODULE_PATH" ]; then
            echo "Error: Module path mismatch!"
            echo "Expected: $MODULE_PATH"
            echo "Actual:   $ACTUAL_MODULE"
            echo "Please update MODULE_PATH in release.yml or fix go.mod"
            exit 1
          fi
          echo "âœ… Module path verified: $ACTUAL_MODULE"

      - name: Check Go module
        run: |
          go mod download
          go mod verify
          go mod tidy
          git diff --exit-code go.mod go.sum || (echo "âŒ go.mod/go.sum not tidy" && exit 1)

      - name: Check for required files
        run: |
          echo "Checking for required files..."
          for file in LICENSE README.md go.mod go.sum; do
            if [ ! -f "$file" ]; then
              echo "âŒ Missing required file: $file"
              exit 1
            else
              echo "âœ… Found: $file"
            fi
          done

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: validate
    if: ${{ !github.event.inputs.skip_tests || github.event.inputs.skip_tests == 'false' }}
    steps:
      - uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.23'

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v3
        with:
          version: latest
          args: --timeout=5m --config=.golangci.yml

  test:
    name: Test
    needs: lint
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: [ 1.23 ]

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: statemachine_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go ${{ matrix.go-version }}
        uses: actions/setup-go@v4
        with:
          go-version: ${{ matrix.go-version }}

      # Install PostgreSQL client tools (psql, pg_isready, etc.)
      - name: Install PostgreSQL client
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      # Wait for Postgres to be ready (optional, healthcheck usually suffices)
      - name: Wait for PostgreSQL
        run: |
          timeout 60s sh -c 'until pg_isready --host=localhost --port=5432 --username=postgres; do sleep 2; done'

      # Create the second database
      - name: Create additional test database
        run: |
          psql -h localhost -U postgres -d statemachine_test -c 'CREATE DATABASE statemachine_test_gorm;'
        env:
          PGPASSWORD: postgres

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install dependencies
        run: go mod download

      - name: Run tests
        env:
          POSTGRES_TEST_URL: postgresql://postgres:postgres@localhost:5432/statemachine_test?sslmode=disable
          POSTGRES_TEST_URL_GORM: postgresql://postgres:postgres@localhost:5432/statemachine_test_gorm?sslmode=disable

        run: go test $(go list ./... | grep -v /examples) -v -race -coverprofile=coverage-${{ matrix.go-version }}-${{ matrix.os }}.out

      - name: Upload coverage
        uses: codecov/codecov-action@v5
        with:
          files: coverage-${{ matrix.go-version }}-${{ matrix.os }}.out
          flags: ${{ matrix.go-version }}-${{ matrix.os }}
  test-examples:
    name: Test Examples
    needs: lint
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: [ 1.23 ]

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: statemachine_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go ${{ matrix.go-version }}
        uses: actions/setup-go@v4
        with:
          go-version: ${{ matrix.go-version }}

      # Install PostgreSQL client tools (psql, pg_isready, etc.)
      - name: Install PostgreSQL client
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      # Wait for Postgres to be ready (optional, healthcheck usually suffices)
      - name: Wait for PostgreSQL
        run: |
          timeout 60s sh -c 'until pg_isready --host=localhost --port=5432 --username=postgres; do sleep 2; done'

      # Create the second database
      - name: Create additional test database
        run: |
          psql -h localhost -U postgres -d statemachine_test -c 'CREATE DATABASE statemachine_test_gorm;'
        env:
          PGPASSWORD: postgres

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install dependencies
        run: go mod download

      - name: Run test-examples
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/statemachine_test?sslmode=disable
          DATABASE_URL_GORM: postgresql://postgres:postgres@localhost:5432/statemachine_test_gorm?sslmode=disable
        #        run: find examples -maxdepth 2 -name "*.go" -print0 | xargs -0 -n1 go run
        run: find examples -maxdepth 2 -type f ! -path '*/distributed_queue/*' -name "*.go" -print0 | xargs -0 -n1 go run
      - name: Upload coverage
        uses: codecov/codecov-action@v5
        with:
          files: coverage-${{ matrix.go-version }}-${{ matrix.os }}.out
          flags: ${{ matrix.go-version }}-${{ matrix.os }}


  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [ test, test-examples, lint ]
    if: ${{ !github.event.inputs.skip_tests || github.event.inputs.skip_tests == 'false' }}
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: true

      - name: Get version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          
          # Validate version format
          if [[ ! $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9\.]+)?$ ]]; then
            echo "âŒ Error: Invalid version format: $VERSION"
            echo "Expected format: vX.Y.Z or vX.Y.Z-pre-release"
            exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "âœ… Version: $VERSION"

      - name: Build all packages
        run: |
          echo "Building package and examples..."
          
          # Build main packages
          go build -v ./...
          
          # Build examples
          for example in examples/*/*.go; do
            if [ -f "$example" ]; then
              echo "Building $example..."
              go build -o /dev/null "$example" || echo "Warning: Failed to build $example"
            fi
          done
          
          # Build pkg packages
          for pkg in $(find pkg -name "*.go" -type f | xargs dirname | sort -u); do
            if [ -d "$pkg" ]; then
              echo "Building package: $pkg"
              go build -o /dev/null "./$pkg" || echo "Warning: Failed to build $pkg"
            fi
          done
          
          echo "âœ… All builds completed successfully"

      - name: Generate SBOM
        run: |
          # Generate Software Bill of Materials
          go install github.com/CycloneDX/cyclonedx-gomod/cmd/cyclonedx-gomod@latest
          cyclonedx-gomod mod -json -output sbom.json

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            sbom.json
            go.mod
            go.sum

  publish:
    name: Publish
    runs-on: ubuntu-latest
    needs: [ build ]
    if: ${{ !github.event.inputs.skip_tests || github.event.inputs.skip_tests == 'false' }}
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: true

      - name: Download artifacts
        uses: actions/download-artifact@v4.0.0

      - name: Get version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Verify module before publish
        run: |
          echo "Verifying module $MODULE_PATH@$VERSION..."
          go mod tidy
          go mod verify
          
          # Verify the module can be downloaded
          echo "Testing module download..."
          GOPROXY=https://proxy.golang.org go mod download $MODULE_PATH@$VERSION 2>/dev/null || true

      - name: Sign release with cosign
        if: github.event_name == 'push'
        uses: sigstore/cosign-installer@main
        continue-on-error: true

      - name: Create GitHub Release
        if: github.event_name == 'push'
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.version.outputs.version }}
          body: |
            ## Release ${{ steps.version.outputs.version }}
            
            ### ğŸ“¦ Installation
            
            ```bash
            go get ${{ env.MODULE_PATH }}@${{ steps.version.outputs.version }}
            ```
            
            ### ğŸ“š Documentation
            
            - **API Documentation**: https://pkg.go.dev/${{ env.MODULE_PATH }}@${{ steps.version.outputs.version }}
            - **Examples**: [examples/](https://github.com/${{ github.repository }}/tree/${{ steps.version.outputs.version }}/examples)
            - **Source Code**: https://github.com/${{ github.repository }}/tree/${{ steps.version.outputs.version }}
            
            ### ğŸš€ Features
            
            - Complete AWS Step Functions State Machine Language implementation
            - Parallel execution support
            - Task delegation to local Go functions
            - Retry policies with exponential backoff
            - YAML/JSON state machine definitions
            - All state types: Task, Parallel, Choice, Wait, Pass, Succeed, Fail
            
            ### ğŸ”§ Testing
            
            Run the test suite:
            ```bash
            go test ./... -tags 'exclude_integration' 
            ```
            
            ### ğŸ“„ License
            
            MIT License - See [LICENSE](https://github.com/${{ github.repository }}/blob/${{ steps.version.outputs.version }}/LICENSE) file.
            
            ---
            
            *Automatically generated release notes*
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, '-') }}
          generate_release_notes: true
          files: |
            LICENSE
            README.md
            go.mod
            go.sum
            sbom.json
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to Go Package Registry
        if: github.event_name == 'push'
        run: |
          echo "ğŸ“¦ Publishing $MODULE_PATH@$VERSION to Go proxy..."
          
          # Trigger Go proxy indexing
          GOPROXY=https://proxy.golang.org go list -m $MODULE_PATH@$VERSION
          
          # Wait for indexing
          sleep 5
          
          # Verify it's available
          echo "Verifying module availability..."
          if GOPROXY=https://proxy.golang.org go mod download $MODULE_PATH@$VERSION 2>/dev/null; then
            echo "âœ… Module published successfully!"
            echo ""
            echo "ğŸ“š Documentation will be available at:"
            echo "https://pkg.go.dev/$MODULE_PATH@$VERSION"
            echo ""
            echo "âš¡ Users can install with:"
            echo "go get $MODULE_PATH@$VERSION"
          else
            echo "âš ï¸  Module may take a few minutes to appear in the proxy"
            echo "Check https://pkg.go.dev/$MODULE_PATH@$VERSION in 5-10 minutes"
          fi

      - name: Sign container image
        if: github.event_name == 'push'
        continue-on-error: true
        run: |
          # Sign the release
          cosign sign --yes ghcr.io/${{ github.repository }}:${{ steps.version.outputs.version }} || echo "Container signing skipped"

  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [ publish ]
    if: always()
    steps:
      - name: Determine status
        id: status
        run: |
          if [[ "${{ needs.publish.result }}" == "success" ]]; then
            echo "result=success" >> $GITHUB_OUTPUT
            echo "color=good" >> $GITHUB_OUTPUT
            echo "message=âœ… Release ${{ needs.build.outputs.version }} published successfully!" >> $GITHUB_OUTPUT
          else
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
            echo "message=âŒ Release failed. Check the workflow logs." >> $GITHUB_OUTPUT
          fi

      #      - name: Send status to Slack
      #        if: failure() && github.event_name == 'push'
      #        uses: 8398a7/action-slack@v3
      #        with:
      #          status: ${{ steps.status.outputs.result }}
      #          fields: workflow,job,commit,repo,ref,author,took
      #        env:
      #          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      #        continue-on-error: true

      - name: Update release badge
        if: success() && github.event_name == 'push'
        run: |
          echo "ğŸ‰ Release ${{ needs.build.outputs.version }} completed!"
          echo ""
          echo "ğŸ“¦ Package: $MODULE_PATH@${{ needs.build.outputs.version }}"
          echo "ğŸ“š Docs: https://pkg.go.dev/$MODULE_PATH@${{ needs.build.outputs.version }}"
          echo "ğŸ·ï¸  Release: https://github.com/${{ github.repository }}/releases/tag/${{ needs.build.outputs.version }}"