# .github/workflows/release.yml
name: Release Go Package

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0, v1.2.3-beta.1
  workflow_dispatch: # Allow manual triggering
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'
      skip_tests:
        description: 'Skip tests (for debugging)'
        required: false
        type: boolean
        default: false

env:
  GO_VERSION: '1.23'
  GOPROXY: 'https://proxy.golang.org,direct'
  GOSUMDB: 'sum.golang.org'
  MODULE_PATH: 'github.com/hussainpithawala/state-machine-amz-go'

permissions:
  contents: write
  id-token: write

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_tests }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go ${{ env.GO_VERSION }}
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: true
          cache: true

      - name: Verify go.mod
        run: |
          ACTUAL_MODULE=$(go list -m)
          if [ "$ACTUAL_MODULE" != "$MODULE_PATH" ]; then
            echo "âŒ Error: Module path mismatch!"
            echo "Expected: $MODULE_PATH"
            echo "Actual:   $ACTUAL_MODULE"
            echo "Please update MODULE_PATH in release.yml or fix go.mod"
            exit 1
          fi
          echo "âœ… Module path verified: $ACTUAL_MODULE"

      - name: Check Go module
        run: |
          go mod download
          go mod verify
          go mod tidy
          git diff --exit-code go.mod go.sum || (echo "âŒ go.mod/go.sum not tidy" && exit 1)

      - name: Check for required files
        run: |
          echo "Checking for required files..."
          for file in LICENSE README.md go.mod go.sum; do
            if [ ! -f "$file" ]; then
              echo "âŒ Missing required file: $file"
              exit 1
            else
              echo "âœ… Found: $file"
            fi
          done

  # Run CI tests before release
  ci-tests:
    name: Run CI Tests
    uses: ./.github/workflows/ci.yml
    if: ${{ !inputs.skip_tests }}

  build:
    name: Build Release
    runs-on: ubuntu-latest
    needs: [ validate, ci-tests ]
    if: ${{ !inputs.skip_tests }}
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: true
          cache: true

      - name: Get version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          
          # Validate version format
          if [[ ! $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9\.]+)?$ ]]; then
            echo "âŒ Error: Invalid version format: $VERSION"
            echo "Expected format: vX.Y.Z or vX.Y.Z-pre-release"
            exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "âœ… Version: $VERSION"

      - name: Build all packages
        run: |
          echo "Building package and examples..."
          
          # Build main packages
          go build -v ./...
          
          # Build examples
          for example in examples/*/*.go; do
            if [ -f "$example" ]; then
              echo "Building $example..."
              go build -o /dev/null "$example" || echo "Warning: Failed to build $example"
            fi
          done
          
          # Build pkg packages
          for pkg in $(find pkg -name "*.go" -type f | xargs dirname | sort -u); do
            if [ -d "$pkg" ]; then
              echo "Building package: $pkg"
              go build -o /dev/null "./$pkg" || echo "Warning: Failed to build $pkg"
            fi
          done
          
          echo "âœ… All builds completed successfully"

      - name: Generate SBOM
        run: |
          # Generate Software Bill of Materials
          go install github.com/CycloneDX/cyclonedx-gomod/cmd/cyclonedx-gomod@latest
          cyclonedx-gomod mod -json -output sbom.json

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            sbom.json
            go.mod
            go.sum

  publish:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: [ build ]
    if: ${{ !inputs.skip_tests }}
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: true
          cache: true

      - name: Download artifacts
        uses: actions/download-artifact@v4

      - name: Get version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Verify module before publish
        run: |
          echo "Verifying module $MODULE_PATH@$VERSION..."
          go mod tidy
          go mod verify
          
          # Verify the module can be downloaded
          echo "Testing module download..."
          GOPROXY=https://proxy.golang.org go mod download $MODULE_PATH@$VERSION 2>/dev/null || true

      - name: Create GitHub Release
        if: github.event_name == 'push'
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.version.outputs.version }}
          body: |
            ## Release ${{ steps.version.outputs.version }}
            
            ### ğŸ“¦ Installation
            
            ```bash
            go get ${{ env.MODULE_PATH }}@${{ steps.version.outputs.version }}
            ```
            
            ### ğŸ“š Documentation
            
            - **API Documentation**: https://pkg.go.dev/${{ env.MODULE_PATH }}@${{ steps.version.outputs.version }}
            - **Examples**: [examples/](https://github.com/${{ github.repository }}/tree/${{ steps.version.outputs.version }}/examples)
            - **Source Code**: https://github.com/${{ github.repository }}/tree/${{ steps.version.outputs.version }}
            
            ### ğŸš€ Features
            
            - Complete AWS Step Functions State Machine Language implementation
            - Message state with async timeout boundary events (BPMN-style)
            - Parallel execution support with distributed queue
            - Task delegation to local Go functions
            - Retry policies with exponential backoff
            - YAML/JSON state machine definitions
            - PostgreSQL persistence with real-time execution tracking
            - Redis-backed distributed queue (Asynq)
            - All state types: Task, Parallel, Choice, Wait, Pass, Succeed, Fail, Message
            
            ### ğŸ§ª Testing
            
            Run the test suite:
            ```bash
            make test-all
            ```
            
            View test coverage:
            ```bash
            make test-coverage
            ```
            
            ### ğŸ“„ License
            
            MIT License - See [LICENSE](https://github.com/${{ github.repository }}/blob/${{ steps.version.outputs.version }}/LICENSE) file.
            
            ---
            
            *Automatically generated release notes*
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, '-') }}
          generate_release_notes: true
          files: |
            LICENSE
            README.md
            go.mod
            go.sum
            build-artifacts/sbom.json
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to Go Package Registry
        if: github.event_name == 'push'
        run: |
          echo "ğŸ“¦ Publishing $MODULE_PATH@$VERSION to Go proxy..."
          
          # Trigger Go proxy indexing
          GOPROXY=https://proxy.golang.org go list -m $MODULE_PATH@$VERSION
          
          # Wait for indexing
          sleep 5
          
          # Verify it's available
          echo "Verifying module availability..."
          if GOPROXY=https://proxy.golang.org go mod download $MODULE_PATH@$VERSION 2>/dev/null; then
            echo "âœ… Module published successfully!"
            echo ""
            echo "ğŸ“š Documentation will be available at:"
            echo "https://pkg.go.dev/$MODULE_PATH@$VERSION"
            echo ""
            echo "âš¡ Users can install with:"
            echo "go get $MODULE_PATH@$VERSION"
          else
            echo "âš ï¸  Module may take a few minutes to appear in the proxy"
            echo "Check https://pkg.go.dev/$MODULE_PATH@$VERSION in 5-10 minutes"
          fi

  notify:
    name: Notify Release
    runs-on: ubuntu-latest
    needs: [ publish ]
    if: always()
    steps:
      - name: Determine status
        id: status
        run: |
          if [[ "${{ needs.publish.result }}" == "success" ]]; then
            echo "result=success" >> $GITHUB_OUTPUT
            echo "color=good" >> $GITHUB_OUTPUT
            echo "message=âœ… Release ${{ needs.build.outputs.version }} published successfully!" >> $GITHUB_OUTPUT
          else
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "color=danger" >> $GITHUB_OUTPUT
            echo "message=âŒ Release failed. Check the workflow logs." >> $GITHUB_OUTPUT
          fi

      - name: Summary
        if: success() && github.event_name == 'push'
        run: |
          echo "ğŸ‰ Release ${{ needs.build.outputs.version }} completed!"
          echo ""
          echo "ğŸ“¦ Package: ${{ env.MODULE_PATH }}@${{ needs.build.outputs.version }}"
          echo "ğŸ“š Docs: https://pkg.go.dev/${{ env.MODULE_PATH }}@${{ needs.build.outputs.version }}"
          echo "ğŸ·ï¸  Release: https://github.com/${{ github.repository }}/releases/tag/${{ needs.build.outputs.version }}"